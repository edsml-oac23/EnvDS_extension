<script>
  const vscode = acquireVsCodeApi();

  const card = document.getElementById('reusable-card');
  const cardDesc = document.getElementById('card-desc');
  const cardBtn = document.getElementById('card-btn');

  let activeTitle = null;

  // Function to attach click handlers (can be called multiple times)
  function attachClickHandlers() {
    document.querySelectorAll('.section-title').forEach(titleEl => {
      // Avoid attaching multiple times
      titleEl.removeEventListener('click', titleEl._clickHandler);
      
      titleEl._clickHandler = () => {
        // 1. Update active state
        if (activeTitle) {
          activeTitle.classList.remove('active');
        }
        titleEl.classList.add('active');
        activeTitle = titleEl;

        // 2. Update card content
        cardDesc.textContent = titleEl.getAttribute('data-desc') || 'No description available.';

        const showBtn = titleEl.getAttribute('data-checkdeps') === 'true';
        cardBtn.classList.toggle('hidden', !showBtn);

        // 3. Move card below this title
        const parentSection = titleEl.closest('.section');
        
        if (card.parentNode) {
          card.parentNode.removeChild(card);
        }
        
        parentSection.appendChild(card);
        card.classList.remove('hidden');

        // 4. Open file/notebook
        const mdPath = titleEl.getAttribute('data-path') || '';
        const notebookPath = titleEl.getAttribute('data-notebook') || '';

        vscode.postMessage({
          command: 'openGuide',
          path: mdPath,
          notebook: notebookPath
        });
      };

      titleEl.addEventListener('click', titleEl._clickHandler);
    });
  }

  // Initial attach (in case content is static)
  attachClickHandlers();

  // Listen for message from extension when TOC is loaded
  window.addEventListener('message', event => {
    const message = event.data;
    if (message.command === 'tocLoaded') {
      attachClickHandlers();  // Re-attach to new dynamic elements
    }
  });

  // Button: check dependencies
  cardBtn.addEventListener('click', () => {
    vscode.postMessage({ command: 'checkDependencies' });
  });
</script>